
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Step 3: Normalisation &#8212; GLM I</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b76e3c8a" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '4.normalisation';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="0.intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="GLM I - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="GLM I - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="0.intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="1.stat-modelling.html">Introduction to Statistical Modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="2.linear-regression-review.html">Review of Linear Regression</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/martynmcfarquhar/PSYCH-ADVANCEDSTATS-GLM1" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/martynmcfarquhar/PSYCH-ADVANCEDSTATS-GLM1/issues/new?title=Issue%20on%20page%20%2F4.normalisation.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/4.normalisation.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Step 3: Normalisation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#direct-normalisation-to-a-template">Direct Normalisation to a Template</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#one-step-normalisation">One-step Normalisation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#two-step-normalisation">Two-step Normalisation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#direct-normalisation-in-spm">Direct Normalisation in SPM</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#unified-segmentation">Unified segmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-mixture-models-for-segmentation">Gaussian Mixture Models for Segmentation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tissue-probability-maps-tpms">Tissue Probability Maps (TPMs)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#anatomical-and-functional-registration">Anatomical and Functional Registration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#normalising-functional-data-in-spm">Normalising functional data in SPM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-graphical-batch-system">Using the Graphical Batch System</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-matlab-code">Using MATLAB Code</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="step-3-normalisation">
<h1>Step 3: Normalisation<a class="headerlink" href="#step-3-normalisation" title="Link to this heading">#</a></h1>
<p>We have previously discussed the principles behind non-linear registration on this course. As a quick review, the reasons for normalising data to a standard space relate to issues of anatomical variability and the problems this poses for analysing groups of scans. In brief, the statistical analysis of fMRI data is performed in voxel-space. As such, it is necessary for all the images to be the same dimensions <em>and</em> for the same voxel coordinates to correspond to the same anatomical locations. Given how substantial anatomical variability can be, this will never be the case for raw fMRI data. As such, normalisation becomes a necessary step in order to bring all the images into the same coordinate space. However, given the complexity of the anatomical differences across subjects, simple affine registration approaches will not be suitable. Instead, we need to use <em>non-linear</em> methods to provide the best correspondance between the data and the standard space template.</p>
<section id="direct-normalisation-to-a-template">
<h2>Direct Normalisation to a Template<a class="headerlink" href="#direct-normalisation-to-a-template" title="Link to this heading">#</a></h2>
<p>The most basic form of spatial normalisation involves the direct registration of an image to an MNI template. This can be performed as either a <em>one-step</em> or <em>two-step</em> procedure.</p>
<section id="one-step-normalisation">
<h3>One-step Normalisation<a class="headerlink" href="#one-step-normalisation" title="Link to this heading">#</a></h3>
<p>In a one-step approach, the image is directly registered with a matching template in MNI space. For instance, a T1 template would be used when normalising an antomical image and an EPI template would be used when normalising a BOLD image. This is shown in <code class="xref std std-numref docutils literal notranslate"><span class="pre">one-step-norm-fig</span></code>.</p>
<figure class="align-default" id="one-step-norm-fig">
<a class="reference internal image-reference" href="_images/one-step.png"><img alt="_images/one-step.png" src="_images/one-step.png" style="width: 800px;" /></a>
<figcaption>
<p><span class="caption-text">Illustration of one-step normalisation.</span><a class="headerlink" href="#one-step-norm-fig" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Although this approach can work well for anatomical images, the poor resolution of the fMRI data, coupled with the limited contrast of the template, means that there is minimal anatomical information that can be used to improve the alignment. As such, most direct normalisation approaches rely on a <em>two-step</em> approach instead.</p>
</section>
<section id="two-step-normalisation">
<h3>Two-step Normalisation<a class="headerlink" href="#two-step-normalisation" title="Link to this heading">#</a></h3>
<p>In a two-step approach, an anatomical image from the same subject is directly registered to a T1 template and then the resultant transformation is applied to the functional data. In theory, this should result in much more accurate normalisation, as the high-resolution anatomical detail from the T1 can be used to derive a much more detailed transformation which can then be applied to the low-resolution functional images. The only proviso is that the functional and anatomical data must be well-aligned before this transformation is estimated, otherwise it will not be accurately applied to the fMRI images. An example of two-step normalisation is shown in <code class="xref std std-numref docutils literal notranslate"><span class="pre">two-step-norm-fig</span></code>.</p>
<figure class="align-default" id="two-step-norm-fig">
<a class="reference internal image-reference" href="_images/two-step-alt.png"><img alt="_images/two-step-alt.png" src="_images/two-step-alt.png" style="width: 800px;" /></a>
<figcaption>
<p><span class="caption-text">Illustration of two-step normalisation.</span><a class="headerlink" href="#two-step-norm-fig" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="direct-normalisation-in-spm">
<h3>Direct Normalisation in SPM<a class="headerlink" href="#direct-normalisation-in-spm" title="Link to this heading">#</a></h3>
<p>For many years, direct normalisation was the main approach implemented in SPM. This can be seen in the <code class="docutils literal notranslate"><span class="pre">Old</span> <span class="pre">Normalise</span></code> tools available under <code class="docutils literal notranslate"><span class="pre">SPM</span> <span class="pre">&gt;</span> <span class="pre">Tools</span> <span class="pre">&gt;</span> <span class="pre">Old</span> <span class="pre">Normalise</span></code> within the batch system. The MNI templates used for this approach are also still available within the SPM folder under <code class="docutils literal notranslate"><span class="pre">spm12</span> <span class="pre">&gt;</span> <span class="pre">toolbox</span> <span class="pre">&gt;</span> <span class="pre">OldNorm</span></code>, with options for normalising T1, T2, EPI, PET, SPECT and PD (proton density) images. However, in 2005, <a class="reference external" href="https://pubmed.ncbi.nlm.nih.gov/15955494/">Ashburner &amp; Friston</a> developed a new approach to normalisation known as <em>unified segmentation</em>. This is now the default method for normalising fMRI images in SPM, as we will explore below.</p>
</section>
</section>
<section id="unified-segmentation">
<h2>Unified segmentation<a class="headerlink" href="#unified-segmentation" title="Link to this heading">#</a></h2>
<p>In the unified segmentation approach, the generation of normalisation parameters is part of the same algorithm used to segment an anatomical image into the different tissue classes. As such, this is a form of <em>two-step</em> normalisation, but one where the generation of the deformation field is part of the segmentation process, rather than through direct registration to an MNI template.</p>
<section id="gaussian-mixture-models-for-segmentation">
<h3>Gaussian Mixture Models for Segmentation<a class="headerlink" href="#gaussian-mixture-models-for-segmentation" title="Link to this heading">#</a></h3>
<p>To understand how this normalisation approach works, we need to first understand how tissue segmentation is performed. Given that different tissue types are fairly easy to discern using a standard T1-weighted structural scan, it stands to reason that the voxel intensities should provide some information about the tissue classes. For instance, white matter is generally brighter than grey matter and CSF tends to be the darkest. We can get a sense of this by plotting the probability distributions for the intensity values of different manually-defined tissue types, as shown in <code class="xref std std-numref docutils literal notranslate"><span class="pre">seg-tissues-fig</span></code>.</p>
<figure class="align-default" id="seg-tissues-fig">
<a class="reference internal image-reference" href="_images/seg-tissues.png"><img alt="_images/seg-tissues.png" src="_images/seg-tissues.png" style="width: 500px;" /></a>
<figcaption>
<p><span class="caption-text">Example of the different intensity distribution for different tissue classes from a T1-weight anatomical image.</span><a class="headerlink" href="#seg-tissues-fig" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Most notable here is both the separation and overlap between the different distributions. If the distributions were entirely separate then we could easily classify the tissues based on intensity alone. Unfortunately, the degree of overlap between these distribution causes problems in terms of deciding whether a voxel is one tissue type or another. Putting this issue to one side for now, we can model the probability distributions for different tissues in an image by using a <em>Gaussian Mixture Model</em>. This is illustrated in <code class="xref std std-numref docutils literal notranslate"><span class="pre">gauss-mix-fig</span></code>, where the yellow bars represent the histogram of image intensities and the black line represents the overall shape of the distribution. The blue lines demonstrate how this overall shape can be approximated by mixing together Gaussian distributions with different means and variances. This is very similar to the idea of recreating a signal using a linear combination of sines and cosines. As such, this approach can be thought of as defining a Gaussian <em>basis set</em> for the image intensities.</p>
<figure class="align-default" id="gauss-mix-fig">
<a class="reference internal image-reference" href="_images/gauss-mix.png"><img alt="_images/gauss-mix.png" src="_images/gauss-mix.png" style="width: 600px;" /></a>
<figcaption>
<p><span class="caption-text">Illustration of a Gaussian mixture model.</span><a class="headerlink" href="#gauss-mix-fig" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>After estimating the shapes of all the Gaussian distributions, we could then assess the probability that a voxel belongs to a tissue class by calculating the probability of its intensity value across all the distributions. Whichever distribution gives the highest probability represents the most likely tissue class. However, as indicated earlier, one of the issues is that there is a degree of overlap between these distributions. This means that certain intensity values will have similar probabilities for multiple tissue types. This speaks to a more general issue known as the <em>partial volume effect</em>, where a voxel can contain multiple tissue types. As such, additional information is needed in order to make a decision about the tissues classification. This additional information comes in the form of <em>tissue probability maps</em> (TPMs). These are images that contain probabilities indicating how likely each voxel in the brain is to be a particular tissue type. These probabilities can be used to compliment the intensity information from the mixture model.</p>
</section>
<section id="tissue-probability-maps-tpms">
<h3>Tissue Probability Maps (TPMs)<a class="headerlink" href="#tissue-probability-maps-tpms" title="Link to this heading">#</a></h3>
<p>In terms of normalisation, the most important element of the unified segmentation algorithm is the TPMs. Examples of the TPMs included with SPM are given in <code class="xref std std-numref docutils literal notranslate"><span class="pre">tpm-fig</span></code> for grey matter, white matter, CSF and air/background. These images are derived from the <a class="reference external" href="http://www.bmap.ucla.edu/portfolio/atlases/ICBM_Probabilistic_Atlases/">ICBM Probabilistic Atlases</a>, which are built from hundreds of scans of young healthy adults. As these scans combine information from across multiple individuals, they are defined in MNI space. As such, in order to use the TPMs to make decisions about an individual subject’s anatomy, the TPMs must be warped from MNI space into subject-space. As such, a deformation field that warps the TPMs from MNI-space to subject-space is created during the process of segmentation. Inverting this field provides the transformation from subject-space to MNI space that can be applied to normalise the functional data.</p>
<figure class="align-default" id="tpm-fig">
<a class="reference internal image-reference" href="_images/tpm.png"><img alt="_images/tpm.png" src="_images/tpm.png" style="width: 400px;" /></a>
<figcaption>
<p><span class="caption-text">Example of the tissue probability maps (TPMs) for grey matter, white matter, CSF and air.</span><a class="headerlink" href="#tpm-fig" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
</section>
<section id="anatomical-and-functional-registration">
<h2>Anatomical and Functional Registration<a class="headerlink" href="#anatomical-and-functional-registration" title="Link to this heading">#</a></h2>
<p>Irrespective of whether we are using a direct normalisation approach or the unified segmentation approach, two-step normalisation depends upon accurate registration between the functional and anatomical data. If this is not the case, then the deformation field will warp the wrong parts of the functional image and the transformation will not work. This is demonstrated in <code class="xref std std-numref docutils literal notranslate"><span class="pre">anat-func-reg-fig</span></code>. As such, the first step in normalisation is to register the structural and functional images together in world-space. Although this could be achieved in a variety of ways, the most efficient is to move the anatomical data so that it is aligned with the functional data. In terms of a reference, a single volume of the functional series could be selected, or an <em>average</em> volume after motion correction. In theory, the latter should be the most accurate representation of the entire fMRI series. As such, in SPM, it is usual to save the mean functional volume after realignment to use as the reference image for registration of the anatomical scan prior to normalisation.</p>
<figure class="align-default" id="anat-func-reg-fig">
<a class="reference internal image-reference" href="_images/anat-func-reg.png"><img alt="_images/anat-func-reg.png" src="_images/anat-func-reg.png" style="width: 600px;" /></a>
<figcaption>
<p><span class="caption-text">Example of how misregistration between an anatomical and functional scan prior to two-step normalisation (<em>top</em>) will cause the warping parameters to be applied incorrectly to the functional data (<em>bottom</em>).</span><a class="headerlink" href="#anat-func-reg-fig" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="normalising-functional-data-in-spm">
<h2>Normalising functional data in SPM<a class="headerlink" href="#normalising-functional-data-in-spm" title="Link to this heading">#</a></h2>
<p>Now that we have discussed the theory of spatial normalisation, we can examine how to perform this step using SPM.</p>
<section id="using-the-graphical-batch-system">
<h3>Using the Graphical Batch System<a class="headerlink" href="#using-the-graphical-batch-system" title="Link to this heading">#</a></h3>
<p>The video below will demonstrate how to normalise the realigned and slice timing corrected functional data, using the SPM graphical interface.</p>
<div style="max-width: 1280px"><div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;"><iframe src="https://livemanchesterac.sharepoint.com/sites/UOM-FBMH-MSc-NCCN/_layouts/15/embed.aspx?UniqueId=a33e96b4-97a3-48af-9a47-ef9c17b11c2c&embed=%7B%22hvm%22%3Atrue%2C%22ust%22%3Atrue%7D&referrer=StreamWebApp&referrerScenario=EmbedDialog.Create" width="1280" height="720" frameborder="0" scrolling="no" allowfullscreen title="5.Normalisation.mov" style="border:none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; height: 100%; max-width: 100%;"></iframe></div></div>
</section>
<section id="using-matlab-code">
<h3>Using MATLAB Code<a class="headerlink" href="#using-matlab-code" title="Link to this heading">#</a></h3>
<p>Unlike the previous preprocessing steps, there are no low-level functions in SPM for performing unified segmentationn. As such, if we want to script this step, we have to use the code generated by the batch system. This will be discussed as part of <em>Advanced Image Analysis</em>, later in the course. For the time being, the older direct approach to normalisation is still available in the form of the <code class="docutils literal notranslate"><span class="pre">spm_normalise</span></code> and <code class="docutils literal notranslate"><span class="pre">spm_write_sn</span></code> functions. To begin with, we use the <code class="docutils literal notranslate"><span class="pre">spm_coreg</span></code> function to register the anatomical and mean functional images.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Launch SPM</span>
<span class="n">spm</span><span class="p">(</span><span class="s">&#39;defaults&#39;</span><span class="p">,</span><span class="s">&#39;FMRI&#39;</span><span class="p">);</span>
<span class="n">spm_figure</span><span class="p">(</span><span class="s">&#39;GetWin&#39;</span><span class="p">,</span><span class="s">&#39;Graphics&#39;</span><span class="p">);</span><span class="w">                    </span><span class="c">% Open graphics window for plots</span>
<span class="n">oldnorm</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">spm</span><span class="p">(</span><span class="s">&#39;dir&#39;</span><span class="p">),</span><span class="s">&#39;toolbox&#39;</span><span class="p">,</span><span class="s">&#39;OldNorm&#39;</span><span class="p">);</span><span class="w"> </span><span class="c">% Path to OldNorm toolbox</span>
<span class="nb">addpath</span><span class="p">(</span><span class="n">oldnorm</span><span class="p">);</span><span class="w">                                   </span><span class="c">% Add the Old Normalise functions</span>

<span class="c">% Load data</span>
<span class="n">func</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">spm_vol</span><span class="p">(</span><span class="s">&#39;arIA_preproc_func.nii&#39;</span><span class="p">);</span><span class="w">          </span><span class="c">% Motion and slice timing corrected data </span>
<span class="n">mfunc</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">spm_vol</span><span class="p">(</span><span class="s">&#39;meanIA_preproc_func.nii&#39;</span><span class="p">);</span><span class="w">        </span><span class="c">% Mean functional (from realignment)</span>
<span class="n">anat</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">spm_vol</span><span class="p">(</span><span class="s">&#39;IA_preproc_anat.nii&#39;</span><span class="p">);</span><span class="w">            </span><span class="c">% Anatomical scan</span>

<span class="c">% Coregister anat -&gt; mean</span>
<span class="n">copts</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">spm_get_defaults</span><span class="p">(</span><span class="s">&#39;coreg.estimate&#39;</span><span class="p">);</span>
<span class="n">spm_coreg</span><span class="p">(</span><span class="n">mfunc</span><span class="p">,</span><span class="n">anat</span><span class="p">,</span><span class="n">copts</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SPM12: spm_coreg (v7320)                           15:22:29 - 06/11/2023
========================================================================
</pre></div>
</div>
<img alt="_images/faf92e29201a1fd68aa799ec79bc26cf8af1047627566d8600a6290a272e1e99.png" src="_images/faf92e29201a1fd68aa799ec79bc26cf8af1047627566d8600a6290a272e1e99.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Printing &#39;Graphics&#39; figure to:
  /home/martyn/Downloads/spm_2023Nov06.ps
Completed                               :          15:22:34 - 06/11/2023
</pre></div>
</div>
</div>
</div>
<p>Then we use the <code class="docutils literal notranslate"><span class="pre">spm_normalise</span></code> and <code class="docutils literal notranslate"><span class="pre">spm_write_sn</span></code> functions to estimate and apply the warpings to the functional data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Normalise (estimate)</span>
<span class="n">template</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">spm_vol</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="n">oldnorm</span><span class="p">,</span><span class="s">&#39;T1.nii&#39;</span><span class="p">));</span><span class="w">                  </span><span class="c">% T1 MNI template</span>
<span class="n">eopts</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="n">spm_get_defaults</span><span class="p">(</span><span class="s">&#39;old.normalise.estimate&#39;</span><span class="p">);</span>
<span class="n">warps</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="n">spm_normalise</span><span class="p">(</span><span class="n">template</span><span class="p">,</span><span class="n">anat</span><span class="p">,</span><span class="s">&#39;warps.mat&#39;</span><span class="p">,[],[],</span><span class="n">eopts</span><span class="p">);</span>

<span class="c">% Normalise (resample)</span>
<span class="n">ropts</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">spm_get_defaults</span><span class="p">(</span><span class="s">&#39;old.normalise.write&#39;</span><span class="p">);</span>
<span class="n">spm_write_sn</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">warps</span><span class="p">,</span><span class="n">ropts</span><span class="p">);</span>
<span class="n">spm_write_sn</span><span class="p">(</span><span class="n">anat</span><span class="p">,</span><span class="n">warps</span><span class="p">,</span><span class="n">ropts</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Smoothing by 0 &amp; 8mm..
Coarse Affine Registration..
Fine Affine Registration..
3D CT Norm...
 iteration  1:  FWHM =  17.38 Var = 10.6076
 iteration  2:  FWHM =  13.49 Var = 2.08803
 iteration  3:  FWHM =  12.86 Var = 1.41758
 iteration  4:  FWHM =  12.69 Var = 1.25582
 iteration  5:  FWHM =  12.65 Var = 1.2107
 iteration  6:  FWHM =  12.64 Var = 1.19879
 iteration  7:  FWHM =  12.65 Var = 1.19538
 iteration  8:  FWHM =  12.65 Var = 1.19327
 iteration  9:  FWHM =  12.65 Var = 1.19175
 iteration 10:  FWHM =  12.64 Var = 1.19175
 iteration 11:  FWHM =  12.65 Var = 1.19068
 iteration 12:  FWHM =  12.64 Var = 1.19021
 iteration 13:  FWHM =  12.64 Var = 1.1893
 iteration 14:  FWHM =  12.63 Var = 1.18903
 iteration 15:  FWHM =  12.64 Var = 1.18759
 iteration 16:  FWHM =  12.63 Var = 1.18759
</pre></div>
</div>
<img alt="_images/1bbdb0ed964f44d22b00ce4ecce26c626038ad9947b43de1d0252c7f2cddb472.png" src="_images/1bbdb0ed964f44d22b00ce4ecce26c626038ad9947b43de1d0252c7f2cddb472.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SPM12: spm_write_sn (v4878)                        15:22:56 - 06/11/2023
========================================================================
Completed                               :          15:22:56 - 06/11/2023
Printing &#39;Graphics&#39; figure to:
  /home/martyn/Downloads/spm_2023Nov06.ps
Saving Parameters..

SPM12: spm_write_sn (v4878)                        15:22:56 - 06/11/2023
========================================================================
Completed                               :          15:23:20 - 06/11/2023

SPM12: spm_write_sn (v4878)                        15:23:20 - 06/11/2023
========================================================================
Completed                               :          15:23:20 - 06/11/2023
</pre></div>
</div>
</div>
</div>
<p>Finally, the results of the normalisation can be checked using <code class="docutils literal notranslate"><span class="pre">spm_check_registration</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Check results</span>
<span class="n">spm_check_registration</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="n">oldnorm</span><span class="p">,</span><span class="s">&#39;T1.nii&#39;</span><span class="p">),</span><span class="w"> </span><span class="k">...</span><span class="c"> % Template </span>
<span class="w">                       </span><span class="s">&#39;warIA_preproc_func.nii,1&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span><span class="c"> % Normalised functional (volume 1)</span>
<span class="w">                       </span><span class="s">&#39;wIA_preproc_anat.nii&#39;</span><span class="p">);</span><span class="w">        </span><span class="c">% Normalised anatomical</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SPM12: spm_check_registration (v7759)              15:23:31 - 06/11/2023
========================================================================
Display /home/martyn/Documents/MATLAB/spm12/toolbox/OldNorm/T1.nii,1
        warIA_preproc_func.nii,1
        wIA_preproc_anat.nii,1
</pre></div>
</div>
<img alt="_images/e9d3c5090f54996ee292b039980187138769ba4fe31bb05e2b0d903dd5ec71ed.png" src="_images/e9d3c5090f54996ee292b039980187138769ba4fe31bb05e2b0d903dd5ec71ed.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "jupyter_matlab_kernel"
        },
        kernelOptions: {
            name: "jupyter_matlab_kernel",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'jupyter_matlab_kernel'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#direct-normalisation-to-a-template">Direct Normalisation to a Template</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#one-step-normalisation">One-step Normalisation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#two-step-normalisation">Two-step Normalisation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#direct-normalisation-in-spm">Direct Normalisation in SPM</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#unified-segmentation">Unified segmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-mixture-models-for-segmentation">Gaussian Mixture Models for Segmentation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tissue-probability-maps-tpms">Tissue Probability Maps (TPMs)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#anatomical-and-functional-registration">Anatomical and Functional Registration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#normalising-functional-data-in-spm">Normalising functional data in SPM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-graphical-batch-system">Using the Graphical Batch System</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-matlab-code">Using MATLAB Code</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dr Martyn McFarquhar
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>